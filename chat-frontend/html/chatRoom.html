<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../bootstrap/css/bootstrap.min.css">
    <script src="../js/jquery-3.4.1.js"></script>
    <script src="../js/time/moment.js"></script>
    <title>FSE Chat Room</title>
</head>
<style>
    .container-fluid {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        align-items: center;
    }

    #sign-out {
        font-size: 20px;
        border-radius: 30px;
        background-color: #F3501D;
        width: 50px;
        height: 50px;
        line-height: 50px;
        text-align: center;
        vertical-align: middle;
        color: #fff;
        border: 1px solid #007bff;
    }

    .name {
        margin-top: 20px;
        margin-bottom: 20px;
    }

    .top {
        width: 100%;
        border: 1px solid #000000;
        border-radius: 20px;
        flex: 1;
        position: relative;
    }
    #online-user{
        display: inline-block;
        border-right: 1px solid #000000;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        bottom: 0;
        /*font-size: 30px;*/
        /*padding-left: 0px;*/
        padding-right: 0px;
    }
    /*#one-user{*/
    /*    border-bottom: 1px solid #000000;*/
    /*}*/

    .info {
        display: inline-block;
        padding-right: 0px;
        padding-left: 0px;
    }

    ul li {
        font-size: 30px;
        /*background: image();*/
    }

    .bot {
        height: 40px;
        margin-top: 20px;
        margin-bottom: 20px;
    }

    .input-text {
        height: 40px;
        border-radius: 10px;

    }

    .btn-send {
        height: 40px;
        border-radius: 10px;
    }


    .username {
        /*display: inline-block;*/
        font-size: 15px;
        border-radius: 30px;
        background-color: pink;
        width: 50px;
        height: 50px;
        line-height: 50px;
        text-align: center;
        vertical-align: middle;
        color: #fff;
        border: 1px solid #007bff;
    }

    .username-other {
        /*display: inline-block;*/
        font-size: 15px;
        border-radius: 30px;
        background-color: #b3d7ff;
        width: 50px;
        height: 50px;
        line-height: 50px;
        text-align: center;
        vertical-align: middle;
        color: #fff;
        border: 1px solid #007bff;
    }

    .msg-text {
        font-size: 20px;
    }

    .time-text {
        font-size: 10px;
    }

    .me {
        padding-top: 10px;
    }

    .other {
        display: flex;
        padding-top: 10px;
        justify-content: flex-end;
        padding-right: 0px;
        margin-left: -5px;
    }

    .other-msg {
        padding-right: 20px;
    }
</style>
<body>
<div class="container-fluid min-vh-100">
    <div class="col-12">
        <h2 class="offset-4 col-4 text-center" style="display: inline-block">Chat Room</h2>
        <button id="sign-out" style="float:right">exit</button>
    </div>
    <!--    <h2>Chat Room</h2>-->
    <div class="top row">
        <div class="row col-2" id="online-user">
<!--            <div class="text-center" style="border-bottom: 1px solid #000000" >-->
<!--                <div style="display: inline-block; font-size: 30px">ddd</div>-->
<!--                <div class="text-right" style="display: inline-block; font-size: 20px;" >111</div>-->
<!--            </div>-->

        </div>
        <div class="info offset-2 col-10 row" id="chat">
        </div>
    </div>
    <div class="bot col-8">
        <input class="col-8 input-text" type="text" id="msg">
        <button class="btn btn-success col-2 btn-send " id="btn">Send</button>
    </div>
</div>
<script src="../js/jquery-3.4.1.js"></script>
<script src="../common/jquery.cookie.js"></script>
<script type="text/javascript" src="../common/jquery.tmpl.js"></script>
<script type="text/javascript" src="../common/axios.js"></script>
<script src="../common/socket.io.js"></script>
<script type="text/javascript" src="../common/config.js"></script>
<script type="text/javascript" src="../common/message.js"></script>
<script type="text/x-jquery-tmpl" id="message">
   {{if chat.username == "me"}}
        <div class="col-12 row me" style="padding-left: 18px;">
                <div class="username">${chat.username}</div>
                <div class="span col-10 text-left">
                    <div class="msg-text row">${chat.message}</div>
                        <div class="time-text row">${chat.date}</div>
                </div>
        </div>
    {{else}}
         <div class="col-12 row other ">
            <div class="span text-right other-msg">
                <div class="msg-text row text-right">${chat.message}</div>
                <div class="time-text row text-right">${chat.date}</div>
            </div>
            <div class="username-other">${chat.username}</div>
        {{/if}}
   </div>


</script>

<script type="text/x-jquery-tmpl" id="one-user">
   <div class="text-center" style="border-bottom: 1px solid #000000" >
        <div style="display: inline-block; font-size: 30px">${loginList.username}  </div>
        <div class="text-right" style="display: inline-block; font-size: 20px;" >${loginList.date}</div>
   </div>
</script>
<script>

    $(function () {
        var ws = io('ws://localhost:8002', {loginList: ['websocket']});
        ws.on('connect', function (e) {
            console.log("server connect success");
            ws.emit('login', {username: $.cookie("username")})
        })
        $("#one-user").tmpl({
            loginList: {
                "username": "Me",
                "date": moment().format('h:mm:ss')
            },
        }).appendTo("#online-user")

        ws.on('loginInfo',function (data) {
            console.log("user login from server")
            for (let onlineUser in data)
            {
                if(data[onlineUser]!= $.cookie("username"))
                {
                    $("#one-user").tmpl({
                        loginList: {
                            "username": data[onlineUser],
                            "date": moment().format('h:mm:ss')
                        },
                    }).appendTo("#online-user")

                }
            }
        })
        ws.on('receiveMsg', function (data) {
            console.log("receiveMsg from server")
            if (data.username == $.cookie("username")) {
                $("#message").tmpl({
                    chat: {
                        "username": "me",
                        "message": data.msg,
                        "date": moment().format('MMMM Do YYYY, h:mm:ss')
                    },
                }).appendTo("#chat")

            } else {
                $("#message").tmpl({
                    chat: {
                        "username": data.username,
                        "message": data.msg,
                        "date": moment().format('MMMM Do YYYY, h:mm:ss')
                    },
                }).appendTo("#chat")

            }

        })
        $(".btn-send").click(function () {
                var usermsg = $("#msg").val()
                if (!usermsg) {
                    showMessage(" Please type information")
                    return;
                }
                if (!usermsg) {
                    showMessage(" msg should not be empty")
                    return;
                }
                ws.emit('sendMsg', {username: $.cookie("username"), msg: $("#msg").val()});
                $("#msg").val('')
            },
        )
        $("#sign-out").click(function () {
                // ws.on("")
                ws.on('disconnect')
                window.location.href = "login.html"
            },
        )
        axios.request({
            url: config.findAllMsg,
            method: "get",
        }).then(res => {
            if (res.data.code === 0) {
                console.log("receiveAllUserMsg from server")
                let data = res.data.data
                for (let allMsg in data) {
                    if (data[allMsg].sender == $.cookie("username")) {
                        $("#message").tmpl({
                            chat: {
                                "username": "me",
                                "message": data[allMsg].msg,
                                "date": data[allMsg].creatTime,
                            },
                        }).appendTo("#chat")

                    } else {
                        $("#message").tmpl({
                            chat: {
                                "username": data[allMsg].sender,
                                "message": data[allMsg].msg,
                                "date": data[allMsg].creatTime,
                            },
                        }).appendTo("#chat")
                    }
                }
            } else {
                showMessage("login fail," + res.data.message);
            }
        })

    })
</script>
</body>
</html>
